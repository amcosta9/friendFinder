<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Friend Finder - Survey</title>
    <script src="https://code.jquery.com/jquery.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div class="container">
    <div class="jumbotron">
        <h1>Friend Finder</h1>
        <hr>
        <h4>Answer a few questions to see your match!</h4>
        <a href="/">
            <button type="button" class="btn btn-default btn-lg"><span><i class="material-icons">fast_rewind</i></span></button>
        </a>
    </div>
    <div class="row">
                <h3 class="panel-title">Survey Questions</h3>
            </div>
               <div class="row">
                    <h3>About You</h3>
                    <div class="input-field col s6">
                        <input id="user-name" type="text" class="validate">
                        <label for="user-name">Name</label>
                    </div>
                    <div class="input-field col s6">
                        <input id="user-photo" type="text" class="validate">
                        <label for="user-photo">Link to Photo</label>
                    </div>
               </div>

    <div class="row">

                    <h3>Questions</h3>
                    <div class="input-field col s12">
                        <select id="q1">
                            <option value="" disabled selected>Please Select One</option>
                            <option value="1">Option 1</option>
                            <option value="2">Option 2</option>
                            <option value="3">Option 3</option>
                            <option value="4">Option 4</option>
                            <option value="5">Option 5</option>
                        </select>
                        <label>Pick a Crayola color</label>
                    </div>
    </div>

                <div class="row">
                    <div class="input-field col s12">
                        <select id="q2">
                            <option value="" disabled selected>Please Select One</option>
                            <option value="1">Option 1</option>
                            <option value="2">Option 2</option>
                            <option value="3">Option 3</option>
                            <option value="4">Option 4</option>
                            <option value="5">Option 5</option>
                        </select>
                        <label>How much do you LOVE absurd Buzzfeed quizzes?</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select id="q3">
                            <option value="" disabled selected>Please Select One</option>
                            <option value="1">Option 1</option>
                            <option value="2">Option 2</option>
                            <option value="3">Option 3</option>
                            <option value="4">Option 4</option>
                            <option value="5">Option 5</option>
                        </select>
                        <label>What kind of french fries do you like?</label>
                    </div>
                </div>
                    <br>
                <div class="row">
                    <div class="text-left">
                        <button type="submit" class="btn btn-primary btn-md" id="search-btn">Your fate awaits...
                        </button>
                    </div> <!-- /.text-left-->
                </div>

    <div class="row">
        <div class="col-lg-12">
            <a href="/api/friends">API Friends Link</a> | <a href="https://github.com/amcosta9/friendFinder">GitHub
            Repo</a>
        </div>
    </div> <!-- /.row-->

    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <h4>Your Results Are In...</h4>
            <div class="modal-body">

            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>



</div> <!-- /.container-->

<script type="text/javascript">
    $('select').material_select();
    $('.modal').modal();
    $("#search-btn").on("click", function (event) {
        event.preventDefault();
        // create new object for user answers

        var newSurvey = {
            name: $("#user-name").val().trim(),
            photo: $("#user-photo").val().trim(),
            scores: [$("#q1").val(), $("#q2").val(), $("#q3").val()]
        };


        var totalDifference = 0,
            currentMatch;
        alert("Searching for Matches");
//        $(".form-group").reset();
        function calcResults(newSurvey) {
            var currentURL = window.location.origin;
            $.ajax({url: currentURL + "/api/friends", method: "GET"})
                .done(function (friendsData) {
                    // Here we are logging the URL so we have access to it for troubleshooting
                    console.log("URL: " + currentURL + "/api/friends");
                    // Here we then log the friends to console, where it will show up as an object.
                    console.log(friendsData);
                    console.log('newSurvey', newSurvey.scores);
                    currentMatch = friendsData[0];
                    var currentMatchDiff = 99;
                    // Loop through and calculate differences for each of the friends
                    for (var i = 0; i < friendsData.length; i++) {
                        totalDifference = 0;
                        console.log('friendsData', friendsData[i].scores);
                        console.log('newsurv scores length', newSurvey.scores.length);
                        for (var j = 0; j < newSurvey.scores.length; j++) {
                            var thisDiff = Math.abs(friendsData[i].scores[j] - newSurvey.scores[j]);
                            totalDifference += thisDiff;
                        } // /newSurvey.scores.length for loop
                        if (totalDifference < currentMatchDiff) {
                            currentMatchDiff = totalDifference;
                            currentMatch = friendsData[i];
                        }
                        console.log(friendsData[i].name);
                        console.log('totalDifference', totalDifference);
                        console.log('currentMatch', currentMatch);
                        console.log('currentMatchDiff', currentMatchDiff);
                    } // /friendsData.length for loop
                    console.log('--------------------------');
                    console.log('Your Match is: ' + currentMatch.name);

                    triggerModal(currentMatch);
                }); // //ajax.done()
        } // /calcResults()

        calcResults(newSurvey);


        // append to modal
        function triggerModal(currentMatch) {
            console.log('trig modal function');

            $(".modal-body").append('<p>Your match is ' + currentMatch.name + '!</p>');
            $(".modal-body").append('<img src="' + currentMatch.photo + '">');


//            $('#resultsModal').modal('show')
            $('#resultsModal').modal('open');
        }

        $.post("/api/survey", newSurvey);
    }); // /.on('click')
</script>
</body>
</html>